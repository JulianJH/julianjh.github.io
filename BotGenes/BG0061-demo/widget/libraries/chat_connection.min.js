var bg_storage_dictionary,asr_confirmation=!1;function bgStorage(e,t,o){for(bg_storage_dictionary_key in bg_storage_dictionary)if("clear"==e)bg_storage_dictionary[bg_storage_dictionary_key].removeItem(bg_storage_dictionary_key+botid);else if(new RegExp(bg_storage_dictionary_key).test(t)){if("set"==e){bg_storage_dictionary[bg_storage_dictionary_key].setItem(t,o);break}if("get"==e)return bg_storage_dictionary[bg_storage_dictionary_key].getItem(t);if("remove"==e)return bg_storage_dictionary[bg_storage_dictionary_key].removeItem(t)}}function saveHistory(){HistoryString=bgStorage("get","chatHistory"+botid),null==HistoryString||""==HistoryString?(HistoryJsonArray=[],firstIter=!0):(showMessageInConsole("JSON.parse(HistoryString) has:"),debug&&console.log(JSON.parse(HistoryString)),HistoryJsonArray=JSON.parse(HistoryString));var e=(new Date).toJSON();try{showMessageInConsole(responseApi),""!=responseApi&&(showMessageInConsole("JSON.parse(responseApi).text: "+JSON.parse(responseApi).text),""==humanText?iter={datetime:e,question:"",response:JSON.parse(responseApi),botid:botid}:(iter={datetime:e,question:humanText,response:JSON.parse(responseApi),botid:botid},humanText=""),showMessageInConsole("saving HistoryJsonArray"),debug&&console.log(iter),"boolean"==typeof mask&&mask&&(iter=maskHistory(iter)),HistoryJsonArray.push(iter),HistoryString=JSON.stringify(HistoryJsonArray),bgStorage("set","chatHistory"+botid,HistoryString))}catch(e){showMessageInConsole("error parsing responseApi "+e)}}function maskHistory(e){return e.question=maskString(e.question),e.response.text=maskString(e.response.text),e}function maskString(e){return e.replace(/\d/g,"#")}function wakeUpBot(){showMessageInConsole("wakeUpBot"),null==user?(showMessageInConsole("getting token"),getToken(xCode)):connectBot()}function connectBot(){var e=bgStorage("get","chatHistory"+botid);if(showMessageInConsole("using template: "+templateBG),showMessageInConsole("botid: "+botid),showMessageInConsole("localHistory:"),debug&&console.log(e),null!=e){firstIter=!1;try{chatHistoryArray=JSON.parse(e),showMessageInConsole("chatHistoryArray:"),debug&&console.log(chatHistoryArray),null!=chatHistoryArray&&loadHistory(chatHistoryArray)}catch(e){showMessageInConsole("BG: this JSON is failling:"),showMessageInConsole(e),recoveryFromChatHistory()}}else recoveryFromChatHistory()}function recoveryFromChatHistory(){showMessageInConsole("proceeding to clean chatHistory."),bgStorage("remove","chatHistory"+botid),chatHistoryArray=[],firstIter=!0;var e="CONNECT IDENTITY "+navigator.userLanguage+" BG "+navigator.systemLanguage+" BG "+navLg+" ip "+ipAddress;GetBotResponse(e+=" BG "+xCode)}function GetBotResponse(t,o){response_shown=!1,void(getBotResponseTimer=0)===o&&(o=!1),$.ajax({async:!0,type:"POST",url:api_endpoint+"message",headers:{Authorization:"Bearer  "+user},data:{user_input:t,env:bg_env},success:function(e){internalComand(e)},error:function(e){e.responseJSON||o?!e.responseJSON&&o?(showMessageInConsole("unable to get responseJSON. Throwing BotErrorText. "),responseToShow={text:BotErrorText,ads:[],buttons:[]},RenderResponse(responseToShow)):500!=e.responseJSON.status_code||o?401==e.responseJSON.status_code?(showMessageInConsole("status_code = 401"),debug&&console.log(e.responseJSON),getToken(xCode)):403==e.status?showMessageInConsole(e.responseJSON):(showMessageInConsole("unable to get responseJSON. "),responseToShow={text:BotErrorText,ads:[],buttons:[]},RenderResponse(responseToShow)):(showMessageInConsole("status_code = 500 "),getBotResponseTimer=setTimeout(GetBotResponse(t,!0),2e3)):(showMessageInConsole("unable to get responseJSON. Will try again. "),GetBotResponse(t,!0))},timeout:2e4})}function getToken(){responseToShow={text:chat_connection_oops,ads:[],buttons:[]},$.ajax({async:!0,type:"POST",url:api_endpoint+"connect",data:{bot_id:botid,env:bg_env,xCode:xCode},success:function(e){e.data?(user=e.data.token,bgStorage("set","bgtoken"+botid,user),responseToShow={text:e.data.initial_response,ads:[],buttons:[]}):showMessageInConsole("no data received getting token. "+e),RenderResponse(responseToShow)},error:function(e){showMessageInConsole("error getting token: "),debug&&console.log(e),RenderResponse(responseToShow)}})}function RenderResponse(e){var t,o;showMessageInConsole("brain responded:"),debug&&console.log(e),e=e||{text:chat_connection_oops,ads:[],buttons:[]},responseApi=JSON.stringify(e),e=purge(e),"basic"==templateBG||"mobile"==templateBG?(responseBot=e.text,responseBotButtons=e.buttons):responseBot=e,canSpeak?(o="basic"==templateBG||"mobile"==templateBG?responseBot:responseBot.text,bgSpeak(o),delayed_response_timer=setTimeout(function(){showRespIfNotYet(!1)},loadFactor*Math.pow(o.length/20,1.2)*delayResponse+3e3)):setTimeout(function(){showResponse()},delayResponse),void 0!==e.geolocation&&0!=e.geolocation.length&&(t=e.geolocation,o=createMapDiv(),t.currente_position.lat=parseFloat(t.currente_position.lat),t.currente_position.lng=parseFloat(t.currente_position.lng),creatMap(o,t.currente_position,t.places)),void 0!==e.ads&&0!=e.ads.length&&setTimeout(function(){renderAds(e.ads)},delayResponse+100)}function internalComand(e){var t=e.data.text;if(t.match(/BGWI([^ ]*)/g)){switch(t=t.match(/BGWI([^ ]*)/)[1]){case"CONF":debug&&console.log("asr_confirmation on"),asr_confirmation=!0;break;case"XCQ":return void setTimeout(function(){GetBotResponse("BGWIXCA "+xCode)},3e3);case"URL":setTimeout(function(){GetBotResponse("BGUSERURL "+function(e){for(var t="",o=0;o<e.length;o++)t+=""+e.charCodeAt(o).toString(16);return t}(window.location.href))},3e3);default:debug&&console.log("UNKNOWN COMMAND")}e.data.text=e.data.text.replace("BGWI"+t,""),debug&&console.log(e.data.text)}switch(e.message){case"bot_reply":RenderResponse(e.data);break;case"bot_getLocation":delayed_geoLocation();break;default:showMessageInConsole('unrecognized "response.message": '+e.message),RenderResponse(e.data)}}function validation(e){return""!=e}function purge(e){return purgeMsj=e.text.trim(),purgeMsj=replaceEmotionsWithEmoji(purgeMsj),purgeMsj=purgeMsj.replace('/"  "/g'," "),e.text=purgeMsj,showMessageInConsole(JSON.stringify(e)),e}function showRespIfNotYet(e){clearTimeout(delayed_response_timer),showMessageInConsole("showRespIfNotYet triggered"),response_shown||(showResponse(),void 0===e||e||(loadFactor*=1.2,2.5<loadFactor&&(toogleSpeaker(),loadFactor=1.4)))}function delayed_geoLocation(){"undefined"!=typeof get_coords?(get_coords(),setTimeout(function(){my_coords.hasOwnProperty("lat")&&my_coords.hasOwnProperty("lon")?GetBotResponse("BGUSERCOORDS "+my_coords.lat+" BG "+my_coords.lon):(showMessageInConsole("error getting_coords. "),GetBotResponse("BGUSERCOORDS BGERR"))},2e3)):(showMessageInConsole("error getting_coords. get_coods() might be unavailable."),setTimeout(function(){GetBotResponse("BGUSERCOORDS BGERR")},3e3))}function helpMe(e){if(showQuickReponse){if(void 0===e||""==e)$("#BotTextInput").val("Ayuda");else if("string"==typeof e)$("#BotTextInput").val(e);else{if("object"!=typeof e)return;$("#BotTextInput").val(e.innerText)}SendMessage()}else if(void 0===e||""==e)GetBotResponse("Ayuda");else if("string"==typeof e)GetBotResponse(e);else{if("object"!=typeof e)return;GetBotResponse(e.innerText)}"object"==typeof e&&e.classList.contains("hide_on_click")&&(e.style.display="none")}function helpMeNow(){showQuickReponse?($("#BotTextInput").val("Ayuda"),SendMessage()):GetBotResponse("Ayuda")}function helpMeOnThis(e){showQuickReponse?($("#BotTextInput").val(e),SendMessage()):GetBotResponse(e)}function SendMessage(){var e=$("#BotTextInput").val();if(/<\s*(script|img|div|br|iframe|li|fk|meta|title)/i.test(e)&&(inputTextDisabled(!0),$("#BotTextInput").val("Possible XSS attempt. Conversation blocked.")),"BGWICLS"==(e=sanitize(e))||"bgwicls"==e)try{bgStorage("clear","chatHistory"),location.reload()}catch(e){}else validation(e)&&canWrite&&(humanText=e,inputTextDisabled(!0),$("#BotTextInput").val(""),showQuestion(e),showMessageInConsole("getting answer for "+e),GetBotResponse(e))}function sanitize(e){return e.replace(/^\s|\s$/g,"").replace(/<%\=/g," ").replace(/&/g," and ").replace(/%>/g," ").replace(/>/g," mayor ").replace(/</g," menor ").replace(/\s+/g," ")}function x2csr(e){("undefined"!=typeof openPopUp&&1==openPopUp?openNewChat:changeChat)(e)}function openNewChat(e){var t=null!=base_url.match(/(.*\.*botgenes\.org)\//i)?"https://help.botgenes.org":protocol+"//"+location.hostname+"/bglive";e=toHex(e),window.open(t+"/help.php?url="+e,"HelpLiveChat","width=460,height=600,scrollbars=NO"),ToggleBot()}function toHex(e){for(var t="",o=0;o<e.length;o++)t+=e.charCodeAt(o).toString(16);return t}function changeChat(e){$(".BotWrapper").fadeOut(500,function(){$(this).empty()}),setTimeout(function(){$(".BotWrapper").html('<div class="BotHeader"><div class="BotClose BotMenuButton" onclick="ToggleBot();"><i class="fa fa-times" aria-hidden="true"></i></div><iframe id="bglive"></iframe>').show(),setColors(),setSpinner(),"function"==typeof resize_chat?resize_chat():$("#bglive").css("margin-top","45px").width(chatWidth).height(chatHeight-45),$("#bglive").css("border","none").attr("src",e).hide(),"undefined"!=typeof botHeaderbglive&&$(".BotHeader").css("background",botHeaderbglive)},650)}function setSpinner(){$(".BotHeader").append('<div class="backgroundColorLoader"><div id="loader"><style>@keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); } </style> </div></div>'),spinnerColor="undefined"==typeof spinnerColor?"#4285f4":spinnerColor,spinnerBGColor="undefined"==typeof spinnerBGColor?"#dbdbdb":spinnerBGColor,$("#loader").css("border","16px solid"+spinnerBGColor).css("border-top","16px solid"+spinnerColor).css("border-radius","50%").css("animation","spin 2s linear infinite").css("margin","9em auto").width(70).height(70),setTimeout(function(){$(".backgroundColorLoader").remove(),$("#bglive").show()},7e3)}function $importNoCache(e){var t=(new Date).getTime();try{t=t.toString()}catch(e){t="3"}$import(e+"?"+t)}function $import(e){var t=document.createElement("script");t.setAttribute("src",e),t.setAttribute("type","text/javascript"),t.className="bg-script",document.getElementsByTagName("head")[0].appendChild(t)}function isMobile(){return!!(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i))}function sanitize(e){return e.replace(/^\s|\s$/g,"").replace(/<%\=/g," ").replace(/&/g," and ").replace(/%>/g," ").replace(/>/g," mayor ").replace(/</g," menor ").replace(/\s+/g," ")}function attachImputEventhandler(){"undefined"!=typeof allow_multiline&&allow_multiline&&(enter_delay=1e3),$("#BotTextInput").attr("placeholder",inputPlaceholder).keyup(function(e){return e.preventDefault(),showMessageInConsole("Writing"),13===e.keyCode&&canWrite?buffer_timer=setTimeout("sendCleanInputMessage()",enter_delay):clearTimeout(buffer_timer),!1})}function sendCleanInputMessage(){var e=(e=document.getElementById("BotTextInput").value).replace(lf_RegExp,pseudo_lf);document.getElementById("BotTextInput").value=e,$("#BotSendMessage").click()}function getIp(){$.ajax({url:base_url+"/tools/getip.php",success:function(e){return e}})}function buildSendBtn(){">"!=sendBtnMessage&&""!=sendBtnMessage&&$("#BotSendMessage").height(sendBtnHeight).empty().append(sendBtnMessage),$("#BotSendMessage").height(sendBtnHeight)}function inputTextDisabled(e){$(".BotTextInput").prop("disabled",e),canWrite=!e}function uiDisabledFalse(){return!("undefined"==typeof inputAlwaysDisabled||!inputAlwaysDisabled)||canWrite}function onPresentingChange(e,t){t||""==responseBot||showRespIfNotYet()}function fire_input(){document.getElementById("textbox").value.replace(lf_RegExp,pseudo_lf).replace(/\s$/,"")}String.prototype.strtr=function(e){"use strict";var t,o,s=this.toString();for(t in e)e.hasOwnProperty(t)&&(o=new RegExp(t,"g"),s=s.replace(o,e[t]));return s},jQuery.fn.extend({bg_focus:function(){isMobile()||this[0].focus({preventScroll:!0})}}),void 0===bg_storage_dictionary&&(bg_storage_dictionary={bgtoken:sessionStorage,chatHistory:sessionStorage}),user=bgStorage("get","bgtoken"+botid),$(document).click(function(e){$(e.target).closest("#div_aux_show").length||$(e.target).closest("#toggleDivHidden").length||$("#div_aux_show").is(":visible")&&$("#div_aux_show")[methodEffectAux](speedEffectAux)}),$("#BotTextInput").on("blur",function(){$("#BotWrapper").css({position:"fixed"})}),"undefined"!=typeof uses_google_api&&uses_google_api&&setTimeout(load_GoogleAPI,1e4);